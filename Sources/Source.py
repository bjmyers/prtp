import numpy as np
from prtp.Rays import Rays
import astropy.units as u

class Source:
    '''
    class Source:
    This class is what is initially passed to an Instrument object. This class
        contains information about how to generate a Rays object for use in
        an instrument
    '''
    
    def __init__(self, num = 0, wave = None, order = None):
        '''
        Function __init__:
        
        Inputs:
        num - The number of photons you want to generate
        wave - The wavelength of the photons. Can be a float or an array that
            has length num. Must be an astropy Quantity
        order - The order of the photons. Can be an integer or an array that
            has length num
        '''
        if (wave is None):
            self.wave = wave
        else:
            if (type(wave) != u.quantity.Quantity):
                raise ValueError('Wave must be an astropy Quantity')
            self.wave = wave.to(u.nm,equivalencies=u.spectral())
        self.num = num
        self.order = order
        self.rays = None
    
    def addMisalignment(self, dx = 0*u.mm, dy = 0*u.mm, dz = 0*u.mm, 
                              dl = 0*u.mm, dm = 0*u.mm, dn = 0*u.mm):
        '''
        Function addMisalignment:
        Initializes misalingments of the Rays
        
        Inputs:
        dx,dy,... - Give the amount that the rays should be transformed in each
            direction. They must all be astropy units
        
        Outputs:
        None
        '''
        if ((type(dx) != u.quantity.Quantity) or (type(dy) != u.quantity.Quantity)
        or (type(dz) != u.quantity.Quantity) or (type(dl) != u.quantity.Quantity)
        or (type(dm) != u.quantity.Quantity) or (type(dn) != u.quantity.Quantity)):
            raise ValueError('Any arguments of addMisalignment must be astropy units!')
        self.dx = dx.to(u.mm)
        self.dy = dy.to(u.mm)
        self.dz = dz.to(u.mm)
        self.dl = dl.to(u.mm)
        self.dm = dm.to(u.mm)
        self.dn = dn.to(u.mm)
    
    def misalign(self,rays):
        '''
        Function Misalign:
        Executes the transformation to misalign the rays
        
        Inputs:
        rays - The rays to be misaligned
        
        Outputs:
        Nothing
        
        Notes:
        - This function uses a try-except block to see if the misalignment 
            values have been specified (if they have not bee initialized, trying
            to access them will yield an error, which means we don't have to
            misalign the rays at all.) But this method makes it difficult to
            determine if a different error is occurring here, consider changing
            how this function works
        '''
        try:
            # Add misalignments if they've been defined
            rays.transform(self.dx.value,self.dy.value,self.dz.value,
                           self.dl.value,self.dm.value,self.dn.value)
        except:
            # This executes if misalignments have not been defined
            pass
    
    def addParams(self,rays):
        '''
        Function addParams:
        Adds the Wavelength and Order Parameters to the Rays object
        
        Inputs:
        rays - The Rays object you want to add Params to
        
        Outputs:
        None
        
        Notes:
        - If no parameters have been defined, errors will be caused down the line
            and it may be difficult to recognize them. But I also want the user
            to be able to define a Source without waves and orders. Think about
            adding a warning to the user that no waves or orders have been 
            added
        '''
        if (self.wave is not None):
            if type(self.wave.value) == np.ndarray:
                rays.addParam('Wavelength',self.wave.value)
            else:
                rays.addParam('Wavelength',np.array([self.wave.value]*len(rays)))
        if (self.order is not None):
            if type(self.order) == np.ndarray:
                rays.addParam('Order',self.order)
            else:
                rays.addParam('Order',np.array([self.order]*len(rays)))
    
    def getRays():
        '''
        Function getRays:
        Returns the Rays that have been generated by generateRays()
        '''
        if self.rays is None:
            self.generateRays()
        return self.rays